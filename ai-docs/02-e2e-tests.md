##  Unit‑test plan for real pages  (ready to hand off)

| Step                          | Tooling choice                                   | Responsibilities for the implementer                                                                                                                                                                                                                                                                |
| ----------------------------- | ------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Harness**                | **Vitest + Puppeteer** (headless Chrome)         | • Spin up a temp HTTP server that serves the target pages (downloaded HTML snapshots to avoid net variability).<br>• Launch Puppeteer in `--disable-extensions` mode, then inject `dist/content.js` directly via `page.addScriptTag`.                                                               |
| **2. Test corpus**            | 10 diverse pages:                                | • Wikipedia article, NYTimes article (static snapshot), Reddit comment page, MDN docs, GitHub README, Medium post, a basic React SPA build, Twitter (static snapshot), a page with RTL text (Arabic), a page heavy in diacritics (French poetry).                                                   |
| **3. Fixtures**               | JSON list of _known good_ translations per page. | Each entry: `{ url: '/fixtures/wiki.html', translations: [{ original, translation, context }] }`                                                                                                                                                                                                    |
| **4. Assertions per page**    |                                                  | 1. Wait `page.waitForSelector('.lexa-root-node', { timeout: 5000 })`.<br>2. `page.$$eval('.lexa-root-node', els => els.length)` must equal `translations.length`.<br>3. For every fixture item: `page.$eval('[data-original-text="..."]', el => el.textContent)` equals expected translation.       |
| **5. Dynamic‑DOM robustness** |                                                  | After assertions, run `page.evaluate(() => { const p=document.createElement('p'); p.textContent='extra '; document.body.prepend(p); });` then re‑run `injectTranslations()` from page context with _same_ translations → number of `.lexa-root-node` elements **must not increase** (de‑dup check). |
| **6. CI integration**         | GitHub Actions                                   | Matrix: `node 20 / Linux`, `node 20 / macOS`. Cache `~/.cache/puppeteer`.                                                                                                                                                                                                                           |
| **7. Performance guardrail**  |                                                  | Assert that total injection time (`console.time('inject')`) is `< 200 ms` for Wikipedia snapshot on desktop Chrome.                                                                                                                                                                                 |

Deliverables:

- `tests/e2e/*.test.ts` – one per page.
- `scripts/download-fixtures.ts` – CLI to refresh snapshots.
- GitHub Action `e2e.yml`.
